"""
AIæç¤ºè¯æ¨¡æ¿æ¨¡å—

ç®¡ç†æ‰€æœ‰ä¸AIäº¤äº’ç›¸å…³çš„æç¤ºè¯æ¨¡æ¿ã€‚
"""
from typing import List, Dict, Any


# æ—…è¡Œé£æ ¼Personaå®šä¹‰
STYLE_PERSONAS = {
    "photography": """
ä½ æ˜¯ä¸€ä½ä¸“ä¸šæ—…è¡Œæ‘„å½±å¸ˆã€‚åœ¨è§„åˆ’è¡Œç¨‹æ—¶ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š
- ä¼˜å…ˆæ¨èæ‘„å½±çƒ­é—¨åœ°ç‚¹å’Œæœ€ä½³æ‹æ‘„æ—¶é—´ï¼ˆä¾‹å¦‚ï¼šæ—¥å‡ºã€æ—¥è½ã€é»„é‡‘æ—¶åˆ»ï¼‰
- æ ‡æ³¨æ¯ä¸ªæ™¯ç‚¹çš„æœ€ä½³æ‹æ‘„è§’åº¦å’Œæœºä½
- è€ƒè™‘å…‰çº¿æ¡ä»¶ï¼šé¿å…æ­£åˆå¼ºå…‰ï¼Œé€‰æ‹©æ—©æ™šæŸ”å’Œå…‰çº¿
- æ¨èé€‚åˆæ‹ç…§çš„å’–å•¡å…ã€è§‚æ™¯å°ç­‰åœºæ‰€
- æé†’å¤©æ°”å¯¹æ‘„å½±çš„å½±å“ï¼ˆé˜´å¤©ã€é›¨å¤©çš„æ‹æ‘„å»ºè®®ï¼‰
""",
    "foodie": """
ä½ æ˜¯ä¸€ä½ç¾é£Ÿè¯„è®ºå®¶å’Œæ—…è¡Œå®¶ã€‚åœ¨è§„åˆ’è¡Œç¨‹æ—¶ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š
- ä¼˜å…ˆæ¨èå½“åœ°ç‰¹è‰²ç¾é£Ÿå’Œç±³å…¶æ—/é«˜è¯„åˆ†é¤å…
- æ ‡æ³¨æ¯å®¶é¤å…çš„æ‹›ç‰Œèœã€äººå‡æ¶ˆè´¹ã€è¥ä¸šæ—¶é—´
- åˆç†å®‰æ’ç”¨é¤æ—¶é—´ï¼šé¿å¼€ç”¨é¤é«˜å³°æœŸï¼Œé¢„ç•™å“å°æ—¶é—´
- æ¨èåœ°é“å°åƒã€è¡—è¾¹ç¾é£Ÿã€å¤œå¸‚ç­‰ä½“éªŒ
- è€ƒè™‘é£Ÿç‰©çš„å­£èŠ‚æ€§å’Œåœ°åŸŸç‰¹è‰²
- ä¸ºç¾é£Ÿæ´»åŠ¨é¢„ç•™å……è¶³æ—¶é—´ï¼ˆè‡³å°‘1.5-2å°æ—¶ï¼‰
""",
    "adventure": """
ä½ æ˜¯ä¸€ä½æˆ·å¤–æ¢é™©çˆ±å¥½è€…ã€‚åœ¨è§„åˆ’è¡Œç¨‹æ—¶ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š
- ä¼˜å…ˆæ¨èå¾’æ­¥è·¯çº¿ã€ç™»å±±ã€éª‘è¡Œã€æ°´ä¸Šæ´»åŠ¨ç­‰æˆ·å¤–ä½“éªŒ
- æ ‡æ³¨æ¯ä¸ªæ´»åŠ¨çš„éš¾åº¦ç­‰çº§ã€æ‰€éœ€è£…å¤‡ã€ä½“åŠ›è¦æ±‚
- è¯„ä¼°å¤©æ°”å¯¹æˆ·å¤–æ´»åŠ¨çš„å½±å“ï¼ˆé›¨å¤©å–æ¶ˆã€é«˜æ¸©è°ƒæ•´ï¼‰
- é¢„ç•™å……è¶³çš„æ´»åŠ¨æ—¶é—´å’Œä¼‘æ¯æ—¶é—´
- æé†’å®‰å…¨æ³¨æ„äº‹é¡¹å’Œåº”æ€¥å‡†å¤‡
- æ¨èæ²¿é€”è¡¥ç»™ç‚¹å’Œä¼‘æ¯åŒº
""",
    "culture": """
ä½ æ˜¯ä¸€ä½æ–‡åŒ–å†å²å­¦è€…ã€‚åœ¨è§„åˆ’è¡Œç¨‹æ—¶ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š
- ä¼˜å…ˆæ¨èåšç‰©é¦†ã€å¤è¿¹ã€å†å²é—å€ã€è‰ºæœ¯å±•è§ˆ
- æä¾›æ¯ä¸ªæ–‡åŒ–åœºæ‰€çš„å†å²èƒŒæ™¯å’Œå‚è§‚äº®ç‚¹
- æ ‡æ³¨è®²è§£æœåŠ¡ã€å¯¼è§ˆæ—¶é—´ã€ç‰¹å±•ä¿¡æ¯
- ä¸ºæ·±åº¦å‚è§‚é¢„ç•™å……è¶³æ—¶é—´ï¼ˆå¤§å‹åšç‰©é¦†è‡³å°‘3-4å°æ—¶ï¼‰
- æ¨èç›¸å…³çš„æ–‡åŒ–ä½“éªŒæ´»åŠ¨ï¼ˆä¼ ç»Ÿæ‰‹å·¥è‰ºã€æ–‡åŒ–è®²åº§ç­‰ï¼‰
- è€ƒè™‘å¼€æ”¾æ—¶é—´å’Œå‘¨ä¸€é—­é¦†ç­‰é™åˆ¶
""",
    "relaxation": """
ä½ æ˜¯ä¸€ä½ä¼‘é—²åº¦å‡ä¸“å®¶ã€‚åœ¨è§„åˆ’è¡Œç¨‹æ—¶ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š
- ä¼˜å…ˆæ¨èèˆ’é€‚æ‚ é—²çš„æ´»åŠ¨ï¼šæ¸©æ³‰ã€SPAã€å…¬å›­æ¼«æ­¥ã€èŒ¶é¦†
- é¿å…è¿‡åº¦ç´§å‡‘çš„è¡Œç¨‹ï¼Œç¡®ä¿å……è¶³çš„ä¼‘æ¯æ—¶é—´
- æ¨èæ™¯è‰²ä¼˜ç¾ã€é€‚åˆæ”¾æ¾çš„åœºæ‰€
- é€‰æ‹©èˆ’é€‚åº¦é«˜çš„é…’åº—å’Œé¤å…
- æ¯å¤©å®‰æ’ä¸è¶…è¿‡3-4ä¸ªæ´»åŠ¨ï¼Œç•™å‡ºè‡ªç”±æ´»åŠ¨æ—¶é—´
- æ¨èé€‚åˆå†¥æƒ³ã€ç‘œä¼½ã€é˜…è¯»çš„å®‰é™åœºæ‰€
""",
    "family": """
ä½ æ˜¯ä¸€ä½äº²å­æ—…è¡Œä¸“å®¶ã€‚åœ¨è§„åˆ’è¡Œç¨‹æ—¶ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼š
- ä¼˜å…ˆæ¨èé€‚åˆå…¨å®¶çš„åœºæ‰€ï¼šåŠ¨ç‰©å›­ã€æ°´æ—é¦†ã€ä¸»é¢˜ä¹å›­ã€ç§‘æŠ€é¦†
- è€ƒè™‘å„¿ç«¥çš„å¹´é¾„å’Œä½“åŠ›ï¼šé¿å…è¿‡é•¿æ­¥è¡Œï¼Œå®‰æ’ä¸­åˆä¼‘æ¯
- æ¨èè®¾æ–½å®Œå–„çš„åœºæ‰€ï¼ˆæ¯å©´å®¤ã€æ— éšœç¢è®¾æ–½ï¼‰
- é€‰æ‹©äº²å­å‹å¥½çš„é¤å…å’Œé…’åº—
- æ ‡æ³¨æ¯ä¸ªåœºæ‰€çš„å„¿ç«¥ç¥¨ä»·å’Œé€‚åˆå¹´é¾„
- é¢„ç•™åº”æ€¥æ—¶é—´ï¼ˆå­©å­éœ€è¦ä¼‘æ¯ã€æ¢å°¿å¸ƒç­‰ï¼‰
- é¿å…å±é™©æ€§é«˜æˆ–éœ€è¦é•¿æ—¶é—´å®‰é™çš„æ´»åŠ¨
"""
}


def poi_to_prompt_line(poi: Dict[str, Any]) -> str:
    """
    å°†POIä¿¡æ¯æ ¼å¼åŒ–ä¸ºæç¤ºè¯ä¸­çš„ä¸€è¡Œã€‚

    Args:
        poi: POIä¿¡æ¯å­—å…¸

    Returns:
        str: æ ¼å¼åŒ–åçš„POIæè¿°è¡Œ

    Examples:
        >>> poi = {'name': 'å¤©å®‰é—¨', 'address': 'ä¸œåŸåŒº', 'lng': 116.39, 'lat': 39.90}
        >>> poi_to_prompt_line(poi)
        '- å¤©å®‰é—¨: ä¸œåŸåŒº åæ ‡:(116.39,39.90), è¯„åˆ†: æ— è¯„åˆ†'
    """
    lng_lat = f"({poi.get('lng', 'æ— ')},{poi.get('lat', 'æ— ')})"
    rating = poi.get('biz_ext', {}).get('rating', 'æ— è¯„åˆ†')
    cost = poi.get('biz_ext', {}).get('cost', 'æœªçŸ¥')

    base_info = f"- {poi.get('name', 'æœªçŸ¥åœ°ç‚¹')}: {poi.get('address', 'åœ°å€æœªçŸ¥')} åæ ‡:{lng_lat}, è¯„åˆ†: {rating}"

    if cost != 'æœªçŸ¥':
        return f"{base_info}, ä»·æ ¼/äººå‡: {cost}å…ƒ"
    return base_info


def build_itinerary_generation_prompt(
    destination_city: str,
    origin_city: str,
    start_date: str,
    end_date: str,
    budget: str,
    budget_type: str,
    custom_budget: str,
    travelers: int,
    travel_styles: List[str],
    custom_prompt: str,
    accommodation: str,
    destination_pois: List[Dict],
    food_pois: List[Dict],
    hotel_pois: List[Dict],
    cultural_pois: List[Dict],
    shopping_pois: List[Dict],
    parent_child_pois: List[Dict],
    weather_data: Dict[str, Any],
    days: int,
    user_pois: List[Dict] = None,
    replan_mode: str = None
) -> str:
    """
    æ„å»ºè¡Œç¨‹ç”Ÿæˆçš„AIæç¤ºè¯ã€‚

    Args:
        destination_city: ç›®çš„åœ°åŸå¸‚
        origin_city: å‡ºå‘åŸå¸‚
        start_date: å¼€å§‹æ—¥æœŸ
        end_date: ç»“æŸæ—¥æœŸ
        budget: é¢„ç®—
        budget_type: é¢„ç®—ç±»å‹ï¼ˆpreset/customï¼‰
        custom_budget: è‡ªå®šä¹‰é¢„ç®—
        travelers: å‡ºè¡Œäººæ•°
        travel_styles: æ—…æ¸¸é£æ ¼åˆ—è¡¨
        custom_prompt: è‡ªå®šä¹‰éœ€æ±‚
        accommodation: ä½å®¿ä¿¡æ¯
        destination_pois: æ™¯ç‚¹POIåˆ—è¡¨
        food_pois: ç¾é£ŸPOIåˆ—è¡¨
        hotel_pois: é…’åº—POIåˆ—è¡¨
        cultural_pois: æ–‡åŒ–åœºæ‰€POIåˆ—è¡¨
        shopping_pois: è´­ç‰©åœºæ‰€POIåˆ—è¡¨
        parent_child_pois: äº²å­åœºæ‰€POIåˆ—è¡¨
        weather_data: å¤©æ°”æ•°æ®
        days: è¡Œç¨‹å¤©æ•°
        user_pois: ç”¨æˆ·é€‰æ‹©çš„POIåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
        replan_mode: é‡æ–°è§„åˆ’æ¨¡å¼ï¼ˆ'incremental'/'complete'/Noneï¼Œå¯é€‰ï¼‰

    Returns:
        str: å®Œæ•´çš„æç¤ºè¯
    """
    # æ ¼å¼åŒ–POIåˆ—è¡¨
    destination_pois_str = '\n'.join([poi_to_prompt_line(poi) for poi in destination_pois[:15]]) if destination_pois else "æš‚æ— æ•°æ®"
    food_pois_str = '\n'.join([poi_to_prompt_line(poi) for poi in food_pois[:15]]) if food_pois else "æš‚æ— æ•°æ®"
    hotel_pois_str = '\n'.join([poi_to_prompt_line(poi) for poi in hotel_pois[:15]]) if hotel_pois else "æš‚æ— æ•°æ®"
    cultural_pois_str = '\n'.join([poi_to_prompt_line(poi) for poi in cultural_pois[:10]]) if cultural_pois else "æš‚æ— æ•°æ®"
    shopping_pois_str = '\n'.join([poi_to_prompt_line(poi) for poi in shopping_pois[:25]]) if shopping_pois else "æš‚æ— æ•°æ®"
    parent_child_pois_str = '\n'.join([poi_to_prompt_line(poi) for poi in parent_child_pois[:25]]) if parent_child_pois else "æš‚æ— æ•°æ®"

    # æ ¼å¼åŒ–å¤©æ°”ä¿¡æ¯å’Œå¤©æ°”å»ºè®®
    weather_str = "æš‚æ— æ•°æ®"
    weather_guidance = ""
    if weather_data and weather_data.get('forecasts'):
        forecasts = weather_data['forecasts'][0].get('casts', []) if weather_data['forecasts'] else []
        if forecasts:
            weather_lines = []
            has_rain = False
            for forecast in forecasts:
                day_weather = forecast.get('dayweather', 'æœªçŸ¥')
                line = f"- æ—¥æœŸ: {forecast.get('date', 'æœªçŸ¥')}, å¤©æ°”: {day_weather}/{forecast.get('nightweather', 'æœªçŸ¥')}, æ¸©åº¦: {forecast.get('nighttemp', 'æœªçŸ¥')}-{forecast.get('daytemp', 'æœªçŸ¥')}Â°C"
                weather_lines.append(line)
                if any(keyword in day_weather for keyword in ['é›¨', 'é›ª', 'å†°é›¹']):
                    has_rain = True
            weather_str = '\n'.join(weather_lines)

            # æ·»åŠ å¤©æ°”å»ºè®®
            if has_rain:
                weather_guidance = """
**å¤©æ°”å»ºè®®**ï¼š
- é¢„æŠ¥æœ‰é™é›¨å¤©æ°”ï¼Œè¯·ä¼˜å…ˆå®‰æ’å®¤å†…æ´»åŠ¨ï¼ˆåšç‰©é¦†ã€ç¾æœ¯é¦†ã€è´­ç‰©ä¸­å¿ƒã€å®¤å†…æ¸¸ä¹åœºç­‰ï¼‰
- æˆ·å¤–æ™¯ç‚¹å»ºè®®å®‰æ’åœ¨å¤©æ°”è¾ƒå¥½çš„æ—¥å­
- é›¨å¤©å‡ºè¡Œè¯·æºå¸¦é›¨å…·ï¼Œæ³¨æ„è·¯é¢æ¹¿æ»‘
- å¯ä»¥å°†é›¨å¤©ä½œä¸ºä½“éªŒå½“åœ°å’–å•¡é¦†ã€èŒ¶é¦†ã€ç‰¹è‰²é¤å…çš„å¥½æ—¶æœº
"""

    # è·å–æ—…è¡Œé£æ ¼Persona
    persona_prompt = ""
    if travel_styles and len(travel_styles) > 0:
        primary_style = travel_styles[0]  # ä½¿ç”¨ç¬¬ä¸€ä¸ªé£æ ¼ä½œä¸ºä¸»è¦Persona
        if primary_style in STYLE_PERSONAS:
            persona_prompt = f"""
**æ—…è¡Œé£æ ¼å®šä½**ï¼š
{STYLE_PERSONAS[primary_style]}
"""

    # å¤„ç†è‡ªå®šä¹‰éœ€æ±‚
    custom_requirements = ""
    if custom_prompt and custom_prompt.strip():
        custom_requirements = f"""
**ç”¨æˆ·è‡ªå®šä¹‰éœ€æ±‚**ï¼š
{custom_prompt}

è¯·åŠ¡å¿…åœ¨è§„åˆ’è¡Œç¨‹æ—¶å……åˆ†è€ƒè™‘ä¸Šè¿°è‡ªå®šä¹‰éœ€æ±‚ï¼Œå¹¶åœ¨è¡Œç¨‹å®‰æ’ä¸­ä½“ç°ã€‚
"""

    # å¤„ç†ä½å®¿ä¿¡æ¯
    accommodation_guidance = ""
    if accommodation and accommodation.strip():
        accommodation_guidance = f"""
**ä½å®¿ä¿¡æ¯**ï¼šç”¨æˆ·æä¾›çš„ä½å®¿ä½ç½®ä¸ºï¼š{accommodation}
åœ¨è§„åˆ’è¡Œç¨‹æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ä¼˜å…ˆå®‰æ’ä½å®¿åœ°é™„è¿‘çš„æ™¯ç‚¹ï¼Œå‡å°‘å¾€è¿”æ—¶é—´
2. åˆç†è§„åˆ’æ¯æ—¥è·¯çº¿ï¼Œä½¿å¾—è¿”å›ä½å®¿åœ°çš„äº¤é€šä¾¿åˆ©
3. å¦‚æœæŸäº›æ™¯ç‚¹è·ç¦»ä½å®¿åœ°è¾ƒè¿œï¼Œå»ºè®®åœ¨æ™¯ç‚¹é™„è¿‘å®‰æ’ç”¨é¤ï¼Œé¿å…ä¸­é€”è¿”å›
4. æ™šé—´æ´»åŠ¨å»ºè®®åœ¨ä½å®¿åœ°é™„è¿‘è¿›è¡Œï¼Œæ–¹ä¾¿ä¼‘æ¯
"""

    # ğŸ†• å¤„ç†ç”¨æˆ·è‡ªé€‰POI
    user_pois_section = ""
    if user_pois and len(user_pois) > 0:
        must_visit_pois = [poi for poi in user_pois if poi.get('priority') == 'must_visit']
        optional_pois = [poi for poi in user_pois if poi.get('priority') == 'optional']

        user_pois_section = "\n**ç”¨æˆ·è‡ªé€‰æ™¯ç‚¹**ï¼š\n"

        if must_visit_pois:
            user_pois_section += "ä»¥ä¸‹æ™¯ç‚¹æ˜¯ç”¨æˆ·ã€å¿…å»ã€‘çš„æ™¯ç‚¹ï¼Œè¯·åŠ¡å¿…å®‰æ’åœ¨è¡Œç¨‹ä¸­ï¼š\n"
            for poi in must_visit_pois:
                location = poi.get('location', {})
                lng = location.get('lng', 'æœªçŸ¥')
                lat = location.get('lat', 'æœªçŸ¥')
                user_pois_section += f"- {poi.get('poi_name', 'æœªçŸ¥æ™¯ç‚¹')}: åæ ‡({lng},{lat}), æ¥æº: {poi.get('source', 'user')}\n"

        if optional_pois:
            user_pois_section += "\nä»¥ä¸‹æ™¯ç‚¹æ˜¯ç”¨æˆ·ã€å¯é€‰ã€‘çš„æ™¯ç‚¹ï¼Œå¦‚æœè¡Œç¨‹æ—¶é—´å…è®¸å¯ä»¥å®‰æ’ï¼š\n"
            for poi in optional_pois:
                location = poi.get('location', {})
                lng = location.get('lng', 'æœªçŸ¥')
                lat = location.get('lat', 'æœªçŸ¥')
                user_pois_section += f"- {poi.get('poi_name', 'æœªçŸ¥æ™¯ç‚¹')}: åæ ‡({lng},{lat}), æ¥æº: {poi.get('source', 'user')}\n"

        user_pois_section += "\n"

    # ğŸ†• å¤„ç†é‡æ–°è§„åˆ’æ¨¡å¼è¯´æ˜
    replan_guidance = ""
    if replan_mode == 'incremental':
        replan_guidance = """
**é‡æ–°è§„åˆ’æ¨¡å¼**ï¼šå¢é‡è§„åˆ’
ç”¨æˆ·æ­£åœ¨è¿›è¡Œå¢é‡è§„åˆ’ï¼Œè¯·åœ¨ä¿ç•™åŸæœ‰è¡Œç¨‹POIçš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ç”¨æˆ·æ–°é€‰æ‹©çš„POIï¼Œå¹¶é‡æ–°ä¼˜åŒ–è·¯çº¿ã€‚
è¯·ç¡®ä¿æ‰€æœ‰ç”¨æˆ·ã€å¿…å»ã€‘çš„POIéƒ½è¢«å®‰æ’åœ¨è¡Œç¨‹ä¸­ã€‚
"""
    elif replan_mode == 'complete':
        replan_guidance = """
**é‡æ–°è§„åˆ’æ¨¡å¼**ï¼šå®Œå…¨é‡æ–°è§„åˆ’
ç”¨æˆ·é€‰æ‹©äº†å®Œå…¨é‡æ–°è§„åˆ’æ¨¡å¼ï¼Œè¯·å¿½ç•¥ä¹‹å‰çš„è¡Œç¨‹å®‰æ’ï¼Œåªä¿ç•™ç”¨æˆ·æ ‡è®°ä¸ºã€å¿…å»ã€‘çš„POIï¼Œç”Ÿæˆå…¨æ–°çš„è¡Œç¨‹è®¡åˆ’ã€‚
æ‚¨å¯ä»¥ä»æ¨èçš„POIåˆ—è¡¨ä¸­é€‰æ‹©æ–°çš„æ™¯ç‚¹ï¼Œä½†å¿…é¡»ç¡®ä¿æ‰€æœ‰ç”¨æˆ·ã€å¿…å»ã€‘çš„POIéƒ½è¢«å®‰æ’åœ¨è¡Œç¨‹ä¸­ã€‚
"""

    prompt = f"""
{persona_prompt}
è¯·ä¸ºç”¨æˆ·è§„åˆ’ä¸€ä¸ªä»{origin_city if origin_city else 'å‡ºå‘åœ°'}åˆ°{destination_city}çš„æ—…æ¸¸è¡Œç¨‹ã€‚
å‡ºè¡Œæ—¥æœŸ: {start_date} è‡³ {end_date}
é¢„ç®—: {budget if budget_type == 'preset' else f'è‡ªå®šä¹‰ {custom_budget}'}
å‡ºè¡Œäººæ•°: {travelers}äºº
æ—…æ¸¸é£æ ¼: {', '.join(travel_styles) if travel_styles else 'æ— ç‰¹å®šåå¥½'}

{custom_requirements}

ä»¥ä¸‹æ˜¯é€šè¿‡é«˜å¾·åœ°å›¾APIè·å–çš„{destination_city}ç›¸å…³ä¿¡æ¯ï¼Œè¯·ç»“åˆè¿™äº›çœŸå®æ•°æ®è§„åˆ’è¡Œç¨‹ã€‚
è¯·ç‰¹åˆ«æ³¨æ„POIåçš„**åæ ‡ä¿¡æ¯ (lng,lat)**ï¼Œè¿™æ˜¯æ‚¨è¿›è¡Œåˆç†è·¯çº¿è§„åˆ’çš„å…³é”®è¾“å…¥ï¼š

æ¨èæ™¯ç‚¹ï¼ˆé™„åæ ‡ï¼‰ï¼š
{destination_pois_str}

æ¨èé¤å…ï¼ˆé™„åæ ‡ï¼‰ï¼š
{food_pois_str}

æ–‡åŒ–åœºæ‰€ï¼ˆåšç‰©é¦†ã€ç¾æœ¯é¦†ç­‰, é™„åæ ‡ï¼‰ï¼š
{cultural_pois_str}

è´­ç‰©åœºæ‰€ï¼ˆé™„åæ ‡ï¼‰ï¼š
{shopping_pois_str}

äº²å­/å®¶åº­åœºæ‰€ï¼ˆé™„åæ ‡ï¼‰ï¼š
{parent_child_pois_str}

å¤©æ°”ä¿¡æ¯ï¼š
{weather_str}

{weather_guidance}

{user_pois_section}

{replan_guidance}

**å¤šå‡ºå…¥å£æ™¯ç‚¹ä¼˜åŒ–æç¤º**ï¼š
å¯¹äºå¤§å‹æ™¯ç‚¹ï¼ˆå¦‚æ•…å®«ã€é¢å’Œå›­ã€å¤©å›ç­‰ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ‚¨é€‰æ‹©æœ€ä¼˜çš„å‡ºå…¥å£ï¼Œä»¥å‡å°‘å›å¤´è·¯å’Œæ­¥è¡Œè·ç¦»ã€‚
åœ¨æè¿°æ´»åŠ¨æ—¶ï¼Œå¦‚æœæ‚¨çŸ¥é“æ¨èçš„å…¥å£/å‡ºå£ï¼ˆå¦‚"æ•…å®«åˆé—¨"ã€"é¢å’Œå›­ä¸œå®«é—¨"ï¼‰ï¼Œå¯ä»¥æ ‡æ³¨å‡ºæ¥ï¼Œä½†è¿™ä¸æ˜¯å¼ºåˆ¶è¦æ±‚ã€‚

è¯·ç»“åˆé«˜å¾·åœ°å›¾çš„æ•°æ®å’Œå¤©æ°”æƒ…å†µï¼Œæä¾›è¯¦ç»†çš„æ¯æ—¥è¡Œç¨‹å®‰æ’ï¼ŒåŒ…æ‹¬ï¼š
1. æ¯å¤©çš„å…·ä½“æ´»åŠ¨å®‰æ’ï¼ˆæ—¶é—´ã€åœ°ç‚¹ã€æ´»åŠ¨å†…å®¹ã€é¢„è®¡åœç•™æ—¶é—´ï¼‰
2. æ¨èçš„äº¤é€šæ–¹å¼å’Œè·¯çº¿è§„åˆ’
3. å½“åœ°ç‰¹è‰²ç¾é£Ÿæ¨è
4. æ™¯ç‚¹é—¨ç¥¨ä¿¡æ¯å’Œå¼€æ”¾æ—¶é—´
5. æ ¹æ®å¤©æ°”æƒ…å†µæä¾›å‡ºè¡Œå»ºè®®

**æ³¨æ„**ï¼šæœ¬æ¬¡è¡Œç¨‹è§„åˆ’ä¸“æ³¨äºæ—…æ¸¸æ´»åŠ¨æœ¬èº«ï¼Œæ— éœ€æ¨èé…’åº—å’Œæœºç¥¨ä¿¡æ¯ã€‚ç”¨æˆ·ä¼šè‡ªè¡Œå®‰æ’ä½å®¿å’Œäº¤é€šã€‚

{accommodation_guidance}

å¯¹äºæ¯ä¸ªæ´»åŠ¨åœ°ç‚¹ï¼Œè¯·æä¾›å‡†ç¡®çš„åœ°å€ä¿¡æ¯ï¼Œä»¥ä¾¿åç»­è·å–ç²¾ç¡®çš„åœ°ç†åæ ‡ã€‚
æ¯å¤©è‡³å°‘å®‰æ’3-5ä¸ªæ™¯ç‚¹ï¼Œåˆç†å®‰æ’æ—¶é—´ï¼Œç¡®ä¿è¡Œç¨‹å……å®ä½†ä¸ç´§å¼ ã€‚
ä¸ºæ¯ä¸ªæ™¯ç‚¹æˆ–æ´»åŠ¨æä¾›é¢„è®¡åœç•™æ—¶é—´ï¼ˆä¾‹å¦‚ï¼š2å°æ—¶ã€åŠå¤©ç­‰ï¼‰ã€‚
æ´»åŠ¨æ—¶é—´åº”è¯¥åˆç†å®‰æ’ï¼Œè€ƒè™‘äº¤é€šæ—¶é—´å’Œåœ°ç‚¹é—´çš„è·ç¦»ã€‚
è¡Œç¨‹åº”å……åˆ†è€ƒè™‘ç”¨æˆ·çš„åå¥½ã€é¢„ç®—å’Œæ—¶é—´å®‰æ’ï¼Œæä¾›å®ç”¨ä¸”ä¸ªæ€§åŒ–çš„å»ºè®®ã€‚

**é‡è¦**ï¼šç”±äºå“åº”é•¿åº¦é™åˆ¶ï¼Œè¯·ç¡®ä¿å®Œæ•´è¾“å‡ºæ‰€æœ‰{days}å¤©çš„è¡Œç¨‹ã€‚å¦‚æœå†…å®¹è¾ƒé•¿ï¼Œè¯·ç²¾ç®€æè¿°ä½†ä¿æŒJSONç»“æ„å®Œæ•´ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ç»“æœï¼Œæ³¨æ„ï¼šåœ°ç‚¹åç§°è¦ä½¿ç”¨ä¸Šé¢æä¾›çš„çœŸå®åœ°ç‚¹åç§°ï¼Œå¹¶ä¸”æ¯ä¸€å¤©éƒ½å¿…é¡»åŒ…å«å¤©æ°”ä¿¡æ¯ï¼Œ**å¿…é¡»ç¡®ä¿JSONç»“æ„å®Œæ•´ï¼Œæ‰€æœ‰æ‹¬å·å’Œå¼•å·éƒ½æ­£ç¡®é—­åˆ**ï¼š
{{
    "itinerary": [
        {{
            "day": 1,
            "date": "{start_date}",
            "weather": {{
                "date": "...",
                "dayweather": "...",
                "nightweather": "...",
                "daytemp": "...",
                "nighttemp": "..."
            }},
            "activities": [
                {{
                    "time": "09:00",
                    "title": "æ´»åŠ¨æ ‡é¢˜ï¼ˆå¿…é¡»ä½¿ç”¨ä¸Šé¢æä¾›çš„çœŸå®åœ°ç‚¹åç§°ï¼‰",
                    "description": "æ´»åŠ¨è¯¦ç»†æè¿°",
                    "duration": "é¢„è®¡åœç•™æ—¶é—´ï¼ˆå¦‚2å°æ—¶ã€åŠå¤©ç­‰ï¼‰",
                    "location": {{
                        "address": "è¯¦ç»†åœ°å€",
                        "lng": "ç»åº¦",
                        "lat": "çº¬åº¦"
                    }}
                }},
                // ... å…¶ä»–æ´»åŠ¨
                {{
                    "time": "20:00",
                    "title": "é…’åº—å…¥ä½/ä¼‘æ¯ï¼ˆä½¿ç”¨æ¨èé…’åº—åç§°ï¼‰",
                    "description": "åŠç†å…¥ä½æ‰‹ç»­ï¼Œäº«å—é…’åº—è®¾æ–½",
                    "duration": "è¿‡å¤œ",
                    "location": {{
                        "address": "æ¨èé…’åº—çš„åœ°å€",
                        "lng": "ç»åº¦",
                        "lat": "çº¬åº¦"
                    }}
                }}
            ]
        }}
    ]
}}
"""
    return prompt


def build_chat_system_prompt(weather_info: Dict[str, Any] = None) -> str:
    """
    æ„å»ºAIèŠå¤©åŠ©æ‰‹çš„ç³»ç»Ÿæç¤ºè¯ã€‚

    Args:
        weather_info: å¯é€‰çš„å¤©æ°”ä¿¡æ¯

    Returns:
        str: ç³»ç»Ÿæç¤ºè¯
    """
    base_prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…æ¸¸è§„åˆ’åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·åˆ¶å®šæœ€ä½³çš„æ—…æ¸¸è·¯çº¿å’Œè¡Œç¨‹å®‰æ’ã€‚è¯·ä»¥å‹å¥½ã€ä¸“ä¸šçš„è¯­æ°”å›ç­”é—®é¢˜ï¼Œå¹¶æ ¹æ®ç”¨æˆ·çš„å…´è¶£ã€æ—¶é—´å’Œé¢„ç®—æä¾›å»ºè®®ã€‚"

    if weather_info:
        weather_prompt = f"""

ç›®çš„åœ°å¤©æ°”ä¿¡æ¯ï¼ˆ{weather_info.get('date', 'æœªçŸ¥æ—¥æœŸ')}ï¼‰:
- ç™½å¤©å¤©æ°”: {weather_info.get('dayweather', 'æœªçŸ¥')}
- å¤œé—´å¤©æ°”: {weather_info.get('nightweather', 'æœªçŸ¥')}
- æœ€é«˜æ¸©åº¦: {weather_info.get('daytemp', 'æœªçŸ¥')}Â°C
- æœ€ä½æ¸©åº¦: {weather_info.get('nighttemp', 'æœªçŸ¥')}Â°C
- é£å‘: {weather_info.get('daywind', 'æœªçŸ¥')}
- é£åŠ›: {weather_info.get('daypower', 'æœªçŸ¥')}

è¯·æ ¹æ®å¤©æ°”æƒ…å†µä¸ºç”¨æˆ·æä¾›å‡ºè¡Œå»ºè®®ã€‚
"""
        return base_prompt + weather_prompt

    return base_prompt
